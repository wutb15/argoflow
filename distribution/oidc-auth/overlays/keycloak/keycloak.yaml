apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://marketplace.azurecr.io/helm/v1/repo
    targetRevision: 9.4.2
    chart: keycloak
    helm:
     parameters:
      - name : auth.adminUser
        value : admin
      - name: auth.managementUser
        value: manager
      - name: proxyAddressForwarding
        value: "true"
      - name: auth.existingSecret
        value: keycloak-secret
      - name: postgresql.existingSecret
        value: keycloak-postgresql
      - name: extraVolumeMounts[0].name
        value: config
      - name: extraVolumeMounts[0].mountPath
        value: "/config"
      - name: extraVolumeMounts[0].readOnly
        value: "true"
      - name: extraVolumes[0].name
        value: config
      - name: extraVolumes[0].secret.secretName
        value: kubeflow-realm
      - name: extraVolumes[1].name
        value: ca-bundle-cert
      - name: extraVolumes[1].configMap.name
        value: my-cluster.my-domain.com
      - name: extraVolumeMounts[1].mountPath
        value: /etc/ssl/certs/
      - name: extraVolumeMounts[1].name
        value: ca-bundle-cert
      - name: extraEnvVars[0].name
        value: KEYCLOAK_EXTRA_ARGS
      - name: extraEnvVars[0].value
        value: "-Dkeycloak.import=/config/kubeflow-realm.json -Dspi-login-protocol-openid-connect-legacy-logout-redirect-uri=true"
      - name: service.type
        value: ClusterIP
      - name: service.port
        value: "8080"
      - name: service.httpsPort
        value: "8443"
      - name: metrics.enabled
        value: "true"
      - name: metrics.serviceMonitor.enabled
        value: "true"
      - name: metrics.serviceMonitor.namespace
        value: monitoring
  destination:
    server: https://kubernetes.default.svc
    namespace: auth
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
